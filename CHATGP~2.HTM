<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatGPT 对系统的了解和改善意见（最新版）</title>
  <style>
    body { font-family: 'Microsoft YaHei','PingFang SC',Arial,sans-serif; margin:0; padding:0; background:#f5f7fa; color:#1f2937; line-height:1.7; }
    .container { max-width:1200px; margin:32px auto; background:#fff; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,0.08); overflow:hidden; }
    header { padding:28px 32px; background:linear-gradient(135deg,#2563eb,#7c3aed); color:#fff; }
    h1 { margin:0; font-size:30px; }
    h2 { margin:0 0 12px 0; font-size:22px; color:#111827; }
    h3 { margin:18px 0 10px 0; font-size:18px; color:#111827; }
    section { padding:24px 32px; border-bottom:1px solid #e5e7eb; }
    ul { margin:8px 0 10px 20px; padding:0; }
    li { margin:6px 0; }
    .tag { display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px; margin-right:8px; }
    .tag-blue { background:#e0f2fe; color:#0369a1; }
    .tag-green { background:#dcfce7; color:#15803d; }
    .tag-amber { background:#fef9c3; color:#92400e; }
    .tag-red { background:#fee2e2; color:#b91c1c; }
    .box { border:1px solid #e5e7eb; border-radius:10px; padding:14px 16px; margin:10px 0; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.03); }
    .ok { background:#ecfdf3; border-left:4px solid #22c55e; }
    .warn { background:#fff7ed; border-left:4px solid #f97316; }
    code { background:#f1f5f9; padding:2px 4px; border-radius:4px; font-size:12px; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>ChatGPT 对系统的了解和改善意见（最新版）</h1>
    <div style="margin-top:6px; opacity:0.9;">更新时间：2025-12-15 ・ 基于当前最新代码/数据</div>
  </header>

  <section>
    <h2>1. 总体评价</h2>
    <div class="box ok">
      <strong>亮点（结合本次自报改进 + 代码现状）：</strong>
      <ul>
        <li>已补充深市覆盖与股票池扩展（自报）；回测指标体系与日志/CORS/成本统计等中优先级项已声明完成。</li>
        <li>数据链路完整：股票池更新 → 数据抓取（含增量）→ 模式训练/验证 → 概率预测 → 前端展示/PDF。</li>
        <li>多数据源适配（Yahoo/AkShare/Tushare/Baostock/模拟），数据库表、索引和预测历史表已存在。</li>
      </ul>
    </div>
    <div class="box warn">
      <strong>主要短板（最新代码扫描仍存在）：</strong>
      <ul>
        <li><strong>启动阻断</strong>：<code>StockAnalyzer</code> 仍在缺少 <code>ANTHROPIC_API_KEY</code> 时直接抛错，导致 FastAPI 无法启动，基础接口也不可用（backend/app/analyzer.py）。</li>
        <li><strong>预测存储链路断裂</strong>：<code>predict_stock_probability</code> 调用 <code>self.db.save_prediction</code>，但 <code>self.db</code> 未定义；<code>/api/predict</code> 仍只写内存不落库，历史/验证接口无数据来源。</li>
        <li><strong>前后端契约不一致</strong>：前端依赖大量 mock 字段（例如 <code>matchedQuantitativeData</code>、示例 K 线），后端实际未返回这些字段，真实数据下会回落到 mock 或展示异常。</li>
        <li>健壮性与安全仍需落实：代码中未看到超时/重试/退避的实际实现；CORS 仅允许 localhost；敏感配置仍需确认通过环境变量加载并禁止入库。</li>
      </ul>
    </div>
  </section>

  <section>
    <h2>2. 关键问题清单（需优先修复）</h2>
    <ol>
      <li><span class="tag tag-red">阻断</span> 解耦密钥：无 <code>ANTHROPIC_API_KEY</code> 时不应抛错崩溃；改为延迟实例化或禁用 AI 路由但保留基础 API。</li>
      <li><span class="tag tag-red">阻断</span> 注入 DB 并落库：<code>StockAnalyzer</code> 构造时传入 <code>StockDatabase</code>；预测任务将结果写入 <code>predictions</code> 表，再返回前 100。</li>
      <li><span class="tag tag-amber">契约</span> 前端改为按实际字段渲染；mock 数据仅示例并明显标注，避免真实数据场景报错。</li>
      <li><span class="tag tag-amber">稳健性</span> 为 Claude/数据源请求添加超时、重试、退避与失败降级，任务失败应可见且不中断服务。</li>
      <li><span class="tag tag-amber">配置</span> CORS 列表可配置，默认含部署域；确保敏感配置只通过环境变量，避免硬编码/入库。</li>
    </ol>
  </section>

  <section>
    <h2>3. 快速修复建议（按优先级）</h2>
    <ul>
      <li><strong>解耦密钥依赖：</strong> <code>StockAnalyzer</code> 仅在需要 AI 的路由中按需实例化；或允许无密钥模式下跳过 AI 路由并返回提示。</li>
      <li><strong>修正 DB 依赖与落库：</strong> 在构造 <code>StockAnalyzer</code> 时传入 <code>db</code>；在预测任务中将结果写入 <code>predictions</code> 表，再返回前 100 个。</li>
      <li><strong>前端契约对齐：</strong> 以 <code>/api/predictions</code> 实际字段（code/name/probability/reason/current_price/last_date）为主渲染；保留 mock 仅作示例，并明显标注。</li>
      <li><strong>容错与超时：</strong> 为 Claude 调用与数据源请求设置超时、重试（指数退避），失败时清晰返回错误并不中断整个任务。</li>
      <li><strong>CORS/配置：</strong> 将 CORS 允许域改为可配置列表，默认包含部署域；确认 .env 不入库，敏感信息仅通过环境变量加载。</li>
    </ul>
  </section>

  <section>
    <h2>4. 中期改进路线</h2>
    <ul>
      <li>数据与特征：在扩大样本/深市覆盖基础上，增加预测结果的定量特征与匹配度输出，便于前端展示可信度。</li>
      <li>验证与回测：将胜率/期望收益/回撤等回测指标写入接口与前端标签，提升可解释性。</li>
      <li>成本与配额：Claude 调用加入批量/截断策略，记录 token 成本与错误率，失败自动降级到低成本模型。</li>
      <li>可观测性：统一日志分级与格式，输出到文件/集中系统；补充任务耗时、API 调用统计、健康检查。</li>
      <li>前端体验：真实/模拟模式可切换，加载/错误态明确；PDF 导出聚焦后端实际字段。</li>
    </ul>
  </section>

  <section>
    <h2>5. 验证清单（修复后建议自测）</h2>
    <ul>
      <li>无密钥：基础健康检查、股票池、统计接口可用；AI 路由提示缺密钥但不崩溃。</li>
      <li>预测链路：任务完成、前 100 结果写入 <code>predictions</code> 表；历史/验证接口能读到刚写入记录。</li>
      <li>前端：真实数据模式下无 mock 字段异常，列表/详情正常渲染；CORS 允许部署域访问。</li>
      <li>异常路径：Claude 超时/限流或数据源失败有超时/重试/降级，任务失败可见且不阻塞后续请求。</li>
    </ul>
  </section>
</div>
</body>
</html>
