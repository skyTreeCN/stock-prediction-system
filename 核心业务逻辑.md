# 股票模式识别系统 - 核心业务逻辑

## 第一章：系统概述

（待补充）

---

## 第二章：模式识别与验证流程（Tag2核心业务逻辑）

### 场景一：模式提取

#### 步骤1.1：SQL筛选样本

**输入**:
- stock_data表（全部历史数据）

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| 涨幅阈值 | 5% | 放宽标准，让AI有足够样本归纳；太高样本不足 |
| 成交量比例 | ≥1.5倍 | 排除缩量上涨（弱势），确保有资金支撑 |
| 成交量窗口 | 前20日均量 | 行业标准，避免单日异常影响 |
| 时间范围 | 最近1年 | 避免跨牛熊市，市场环境一致性 |
| 排除ST | 是 | ST股波动异常，非正常技术走势 |
| 当日涨幅 | >1% | 排除跳空开盘（非连续走势） |
| 涨停排除 | 否 | 涨停也是一种模式，可能有情绪溢价但不排除 |
| 样本数量 | 500 | 平衡样本覆盖度和噪声比例 |
| 涨幅计算 | T+2日（3天） | 短期效果验证，符合实际交易周期 |

**输出**:
- 500条记录
- 每条包含：股票代码/名称、T0~T2三日数据、涨幅、成交量比

---

#### 步骤1.2：获取样本的完整K线上下文

**输入**:
- 步骤1.1的500条记录

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| 上下文窗口 | T0前30天 + T0~T+2共3天 | 前30天用于识别趋势和形态，T0~T+2验证上涨过程 |

**输出**:
- 500个样本
- 每个样本含33天完整K线数据（T0前30天 + T0~T+2共3天）

---

#### 步骤1.3：AI提取模式

**输入**:
- 步骤1.2的500个样本（含完整K线）

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| AI模型 | Sonnet 4.5 | 归纳总结任务难度高，需要强推理能力 |
| 目标模式数 | 不限（AI自主判断） | 避免人为限制，让数据自己说话 |
| 最低样本数 | 每模式≥20案例 | 确保模式有统计意义，非偶然 |
| 是否要量化参数 | 是 | 用于场景二程序预筛选，降低AI调用成本 |

**输出**:
- 5-10个上涨模式
- 每个模式包含：
  - pattern_id（模式编号）
  - pattern_name（模式名称）
  - description（文字描述）
  - parameters（量化参数：震荡天数、振幅、成交量比等）
  - key_features（关键特征列表）
  - match_rules（匹配规则：必须条件+加分项）
  - example_stocks（示例股票代码）
  - training_sample_count（该模式在500样本中的数量）

---

#### 步骤1.4：保存模式到数据库

**输入**:
- 步骤1.3的模式列表

**处理**:
- 清空rising_patterns表
- 插入新模式
- 扩展字段（parameters、match_rules）

**输出**:
- 数据库更新完成
- 返回提取了N个模式

---

### 场景二：模式验证

#### 步骤2.1：获取待验证股票列表

**输入**:
- stock_pool表（股票池）

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| 验证模式 | 日常监控 / 历史回测 | 日常100只，历史500只；影响样本量 |
| 股票池范围 | 上证50 + 上证180 + 上证380 | 当前系统已有成分股，约600只 |
| 筛选原则 | is_active = 1 | 只选激活状态的股票 |
| 是否随机 | 否，使用stock_pool表的全部激活股票 | 保证每次验证的可比性 |

**输出**:
- 日常模式：约100只股票代码（从stock_pool中随机抽取或按流动性排序取前100）
- 回测模式：stock_pool表中全部激活股票（约600只）

---

#### 步骤2.2：获取股票历史K线

**输入**:
- 步骤2.1的股票代码列表

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| 历史天数 | 30日 | Opus推荐，平衡模式识别完整性和噪声 |
| 计算均量 | 20日均量 | 与场景一一致，用于量化参数匹配 |

**输出**:
- 100个股票数据（日常）或 600个（回测）
- 每个含最近30天K线、20日均量

---

#### 步骤2.3：程序预筛选（基于量化参数）

**输入**:
- 步骤2.2的股票K线数据
- 步骤1.3的模式量化参数

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| 是否启用 | 是 | 利用量化参数快速过滤，大幅降低AI调用量 |
| 筛选逻辑 | 严格匹配parameters | 只有满足数值条件的才进入AI验证 |

**处理**:
- 遍历每只股票×每个模式
- 用量化参数判断（如：震荡天数3-7、成交量>1.5倍）

**输出**:
- 约20-30个候选匹配（视市场环境而定，从100只中筛出）
- 注意：这是从100只中筛出的"可能匹配"数量，并非最终验证样本数
- 每个候选含：股票代码、候选模式列表、K线数据

**关于样本数说明**:
- 程序预筛选的20-30只 = 当天符合模式特征的股票（正常情况）
- 如果市场环境好，可能有50-80只候选
- 如果市场环境差，可能只有5-10只候选
- 最终验证样本数 = 累积多天的预测结果（如一个月累积100-200个预测样本）

---

#### 步骤2.4：AI精确匹配

**输入**:
- 步骤2.3的候选列表（20-30个）
- 模式完整定义（文字+特征+规则）

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| AI模型 | Haiku 3.5 | 匹配任务难度中低，性价比优先 |
| 匹配阈值 | 70% | 相似度低于70%不算匹配，避免误报 |
| 最少匹配数 | 2个模式 | 多数投票机制，提高可信度 |

**处理**:
- AI判断每个候选股票与每个模式的匹配度
- 返回匹配度百分比

**输出**:
- 5-15个最终预测
- 每个包含：股票代码、匹配的模式列表、匹配度、预测上涨

---

#### 步骤2.5：计算模式准确率（T+3后）

**输入**:
- 步骤2.4的预测结果
- T+2日后的实际股价数据

**参数配置**:

| 参数 | 配置值 | 理由 |
|------|--------|------|
| 验证标准 | 涨幅≥5% | 与场景一一致（不能改） |
| 时间窗口 | T+2日 | 与场景一一致（不能改） |
| 淘汰阈值 | 准确率<40% | 低于此值的模式标记为不可用 |

**输出**:
- 整体准确率（如48%）
- 每个模式的准确率统计：
  - 预测数
  - 成功数
  - 准确率百分比
- 不可用模式列表

---

#### 步骤2.6：更新模式表

**输入**:
- 步骤2.5的验证结果

**处理**:
- 更新rising_patterns表的validated_success_rate、validation_sample_count、validation_date字段
- 准确率<40%的设置is_active=false

**输出**:
- 数据库更新完成
- 返回可用模式数量

---

### 关键参数一致性检查

| 参数 | 场景一 | 场景二 | 必须一致 |
|------|--------|--------|---------|
| 涨幅标准 | 5% | 5% | ✅ 是 |
| 时间窗口 | T+2 | T+2 | ✅ 是 |
| 成交量窗口 | 20日均量 | 20日均量 | ✅ 是 |

---

### 验证样本数补充说明

#### 单日验证 vs 累积验证

| 维度 | 单日验证 | 累积验证（推荐） |
|------|---------|----------------|
| 每日候选数 | 20-30只 | 20-30只 |
| 验证周期 | 1天 | 1个月（约20个交易日） |
| 累积样本数 | 20-30个 | 400-600个 |
| 统计可信度 | ⚠️ 低（样本太少） | ✅ 高（样本充足） |

#### 推荐验证方案

**方式A：历史回测验证（一次性）**
- 目的：验证模式初始准确率
- 方法：从历史数据中选取过去3个月
- 样本：600只股票 × 60个交易日 = 可能产生500-1000个匹配样本
- 优点：快速验证，样本充足

**方式B：实时监控验证（持续）**
- 目的：持续跟踪模式表现
- 方法：每日从100只股票池筛选候选
- 样本：每日20-30个 × 20天 = 累积400-600个样本
- 优点：反映当前市场环境

---

## 第三章：技术实现细节

（待补充）
