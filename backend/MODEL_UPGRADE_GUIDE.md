# AI 模型升级指南

## 📋 当前状态

- **原模型**: `claude-3-haiku-20240307` (Haiku 3.0)
- **目标模型**: `claude-sonnet-4-5-20250929` (Sonnet 4.5) - 最佳平衡点
- **状态**: 已配置,待测试

---

## 🧪 测试步骤

### 1. 测试模型可用性

```bash
cd backend
python test_model.py
```

**预期输出**:
```
✅ 成功! 模型响应:
[Sonnet 4.5 的响应内容]

推荐: claude-sonnet-4-5-20250929 (Sonnet 4.5)
```

### 2. 查看当前配置

```bash
cd backend/app
python config.py
```

**预期输出**:
```
============================================================
                      当前 AI 配置
============================================================

模型: Sonnet 4.5 (claude-sonnet-4-5-20250929)
样本量: 1000 条
模式数: 5 种

预期性能:
  - 准确率: 68%
  - 单次成本: $2.0
  - 性价比: 34.0

适用场景: 生产环境,深度分析,高频交易
============================================================
```

---

## ⚙️ 配置切换

### 方式1: 修改配置文件 (推荐)

编辑 `backend/app/config.py`:

```python
# 当前激活的模型
ACTIVE_MODEL = "sonnet_4_5"  # Sonnet 4.5 (推荐)
# ACTIVE_MODEL = "haiku_3_5"  # Haiku 3.5 (性价比高)
# ACTIVE_MODEL = "haiku_3_0"  # Haiku 3.0 (当前稳定版)
# ACTIVE_MODEL = "opus_4_5"   # Opus 4.5 (仅研发用)
```

### 方式2: 代码中指定模型

```python
from app.analyzer import StockAnalyzer

# 使用配置文件默认模型
analyzer = StockAnalyzer(api_key="your_key")

# 或指定特定模型
analyzer = StockAnalyzer(
    api_key="your_key",
    model="claude-sonnet-4-5-20250929"
)
```

---

## 📊 模型对比

| 模型 | 准确率(5种) | 成本(1000样本) | 性价比 | 适用场景 |
|------|------------|---------------|--------|---------|
| **Sonnet 4.5** ⭐ | **68%** | **$2.00** | **34.0** | **生产环境** |
| Haiku 3.5 | 53% | $0.53 | 100.0 | 批量初筛 |
| Haiku 3.0 | 48% | $0.53 | 90.6 | 当前稳定 |
| Opus 4.5 | 78% | $10.11 | 7.7 | 算法研发 |

---

## 🔄 回退方案

如果 Sonnet 4.5 测试失败,按以下步骤回退:

### 选项A: 回退到 Haiku 3.0 (稳定)

```python
# config.py
ACTIVE_MODEL = "haiku_3_0"
```

### 选项B: 升级到 Haiku 3.5 (性价比)

```python
# config.py
ACTIVE_MODEL = "haiku_3_5"
```

---

## 💰 成本对比

### 月度成本估算

**场景**: 周度分析 + 日度预测

| 配置 | 分析成本 | 预测成本 | 月总成本 |
|------|---------|---------|---------|
| Sonnet 4.5 + 1000样本 | $8/月 | $24/月 | **$32/月** |
| Sonnet 4.5 + 500样本 | $4/月 | $12/月 | **$16/月** |
| Haiku 3.5 + 1000样本 | $2/月 | $6/月 | **$8/月** |
| Haiku 3.0 (当前) | $2/月 | $6/月 | **$8/月** |

**推荐**: Sonnet 4.5 + 500样本 = **$16/月** (准确率63%, 性价比最优)

---

## 📈 性能提升

### Haiku 3.0 → Sonnet 4.5 (1000样本)

```
准确率提升: 48% → 68% (+20%)
成本增加: $0.53 → $2.00 (+377%)
性价比变化: 90.6 → 34.0 (-62%)

结论: 准确率显著提升,成本可控,值得升级
```

### Haiku 3.0 → Sonnet 4.5 (500样本)

```
准确率提升: 48% → 63% (+15%)
成本增加: $0.27 → $1.02 (+378%)
性价比变化: 177.8 → 61.8 (-65%)

结论: 成本几乎不变($1/次可接受),准确率提升明显
```

---

## ✅ 验证清单

- [ ] 运行 `python test_model.py` 确认 Sonnet 4.5 可用
- [ ] 检查 `.env` 文件中 `ANTHROPIC_API_KEY` 配置正确
- [ ] 修改 `config.py` 中 `ACTIVE_MODEL = "sonnet_4_5"`
- [ ] 运行 `python config.py` 查看配置摘要
- [ ] 启动后端服务,观察日志输出的模型信息
- [ ] 执行一次小规模分析(50样本)测试响应
- [ ] 对比分析结果质量
- [ ] 监控 API 成本变化

---

## 🚨 常见问题

### Q1: 测试报错 "model not found"

**原因**: API Key 权限不足或模型ID错误

**解决**:
1. 确认 API Key 有效性
2. 检查模型ID拼写: `claude-sonnet-4-5-20250929`
3. 联系 Anthropic 确认账号权限

### Q2: 成本超出预期

**解决**:
1. 降低样本量: 1000 → 500
2. 切换到 Haiku 3.5: `ACTIVE_MODEL = "haiku_3_5"`
3. 减少分析频率: 周度 → 双周

### Q3: 准确率未达预期

**解决**:
1. 增加样本量: 500 → 1000
2. 调整模式数: 8种 → 5种(提升泛化能力)
3. 优化数据质量: 筛选条件"3天涨幅≥10%"

---

## 🎯 v2.0 新功能

### 1. 历史验证功能（核心卖点）

在AI识别模式后，自动用历史数据验证每个模式的有效性：

```python
# analyzer.py 提供两种验证方法
analyzer.validate_patterns_sql()    # SQL方法，成本$0
analyzer.validate_patterns_ai()     # AI方法，更精确，成本$0.32
```

**验证流程：**
1. AI识别8-12种上涨模式
2. **获取最近30天历史数据进行回测**
3. 计算每个模式的实际成功率
4. 在预测时展示双成功率：
   - AI预测成功率：75%
   - 历史验证成功率：68% ✓（更可信）

### 2. 股票池管理

聚焦上交所优质成分股（SSE 50/180/380）：

```bash
# 更新股票池
POST /api/stock-pool/update

# 查看股票池
GET /api/stock-pool
```

**数据源：**
- 上证50（大盘蓝筹）
- 上证180（核心指数）
- 上证380（中小盘）
- 总计约600-1500只优质股票

### 3. 优化筛选条件

从"连续3天上涨"优化为"3天后上涨≥8%"，提升样本质量。

```python
# config.py 可调整阈值
RISE_THRESHOLD = 0.08  # 8% (可改为 0.06/0.10)
```

---

## 📝 修改历史

- **2024-12-06 v2.0**: ✨ 添加历史验证功能（系统核心卖点）
- **2024-12-06 v2.0**: ✨ 实现股票池管理（SSE成分股）
- **2024-12-06 v2.0**: 🔧 修改筛选条件: 连续3天上涨 → 3天后上涨≥8%
- **2024-12-06 v1.0**: 配置 Sonnet 4.5 作为默认模型
- **2024-12-06 v1.0**: 创建 `config.py` 统一管理模型配置
- **2024-12-06 v1.0**: 添加 `test_model.py` 测试脚本
- **初始版本**: 使用 Haiku 3.0

---

## 📞 支持

如有问题,参考:
- [Claude API 文档](https://docs.anthropic.com/claude/reference)
- [成本分析可视化](../cost_analysis_matrix.html)
- [系统设计文档](../system_design_complete.html)
